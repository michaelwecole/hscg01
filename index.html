<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hospital Supply Chain Game</title>
  <script>
    // Ensure the global exists before assigning config to avoid ReferenceError in some browsers
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      safelist: [
        'bg-green-100','text-green-700',
        'bg-amber-100','text-amber-700',
        'bg-red-100','text-red-700'
      ]
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 24px rgba(2,6,23,.08);padding:1.25rem}
    .btn{padding:.5rem 1rem;border-radius:.75rem;color:#fff;box-shadow:0 4px 10px rgba(2,6,23,.12)}
    .btn-primary{background:#2563eb}.btn-primary:hover{background:#1d4ed8}
    .btn-secondary{background:#475569}.btn-secondary:hover{background:#334155}
    .pill{padding:.125rem .5rem;font-size:.75rem;border-radius:9999px;background:#f1f5f9}
    .mono{font-variant-numeric:tabular-nums}
  </style>
  <script>
    // Small helper for copy feedback
    function toast(msg){
      const d=document.createElement('div');
      d.textContent=msg; d.className='fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-sm px-3 py-2 rounded-lg shadow';
      document.body.appendChild(d); setTimeout(()=>d.remove(),1200);
    }
  </script>
</head>
<body class="min-h-screen bg-slate-50">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">Hospital Supply Chain Game — Healthcare</h1>
      <span id="statusPill" class="pill">offline</span>
    </header>

    <!-- Error banner -->
    <div id="errorBanner" class="hidden mt-3 p-3 rounded-lg bg-red-100 text-red-700 text-sm"></div>

    <!-- Lobby -->
    <section class="card" id="lobby">
      <h2 class="text-lg font-semibold mb-3">Lobby</h2>
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium">Display Name</label>
          <input id="nameInput" class="mt-1 w-full border rounded-lg p-2" placeholder="e.g., Team A / Michael" />
        </div>
        <div>
          <label class="block text-sm font-medium">Session Code</label>
          <input id="codeInput" class="mt-1 w-full border rounded-lg p-2 uppercase" maxlength="8" placeholder="HSCG1234" />
        </div>
        <div>
          <label class="block text-sm font-medium">Passcode</label>
          <input id="passInput" class="mt-1 w-full border rounded-lg p-2" placeholder="4–6 digits" />
        </div>
        <div class="flex items-end gap-2">
          <button id="createBtn" class="btn btn-primary">Create (Instructor)</button>
          <button id="joinBtn" class="btn btn-secondary">Join (Player)</button>
        </div>
      </div>
      <details class="mt-4">
        <summary class="cursor-pointer text-slate-700">How it works</summary>
        <ol class="list-decimal ml-6 mt-2 text-sm text-slate-600">
          <li>Instructor creates a session and shares the code.</li>
          <li>Players join, choose a role, and submit weekly requisitions.</li>
          <li>App simulates shipments, receipts (lead time), inventory, backlog, and fill-rate.</li>
        </ol>
      </details>
    </section>

    <!-- Instructor -->
    <section class="card hidden" id="instructorPanel">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Instructor — <span id="sessionCodeHdr" class="font-mono"></span></h2>
        <div class="flex items-center gap-3">
          <label class="text-sm"><input id="transparencyChk" type="checkbox" class="mr-1">Transparency</label>
          <button id="advanceBtn" class="btn btn-primary">Advance Week</button>
          <button id="resetBtn" class="btn btn-secondary">Reset Session</button>
        </div>
      </div>

      <div class="grid md:grid-cols-4 gap-4 mt-4">
        <div>
          <label class="block text-sm font-medium">Item</label>
          <input id="itemName" class="mt-1 w-full border rounded-lg p-2" value="PPE - N95 Masks" />
        </div>
        <div>
          <label class="block text-sm font-medium">Weeks</label>
          <input id="weeks" type="number" min="4" max="52" class="mt-1 w-full border rounded-lg p-2" value="24" />
        </div>
        <div>
          <label class="block text-sm font-medium">Lead Time</label>
          <input id="leadTime" type="number" min="0" max="6" class="mt-1 w-full border rounded-lg p-2" value="2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Initial Inv</label>
          <input id="initInv" type="number" min="0" class="mt-1 w-full border rounded-lg p-2" value="120" />
        </div>
        <div>
          <label class="block text-sm font-medium">Scenario</label>
          <select id="scenario" class="mt-1 w-full border rounded-lg p-2">
            <option>Normal</option>
            <option>Transparency On (Info Only)</option>
            <option>Severe Surge + Recall</option>
          </select>
        </div>
        <div class="md:col-span-3">
          <label class="block text-sm font-medium">Base Weekly Consumption (comma‑separated; length = Weeks)</label>
          <textarea id="baseDemand" rows="2" class="mt-1 w-full border rounded-lg p-2 font-mono text-sm"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium">Factory Outage Weeks</label>
          <input id="factoryOutage" class="mt-1 w-full border rounded-lg p-2" placeholder="14-16" />
        </div>
        <div>
          <label class="block text-sm font-medium">Prime Vendor Outage Weeks</label>
          <input id="primeOutage" class="mt-1 w-full border rounded-lg p-2" placeholder="18-19" />
        </div>
      </div>
      <div class="mt-4 flex items-center gap-2">
        <button id="applyControlBtn" class="btn btn-secondary">Apply/Reset Control</button>
        <span class="text-sm text-slate-600">Current Week: <b id="currentWeekLbl">—</b></span>
      </div>

      <!-- Shareable role links (auto-created after session creation) -->
      <div id="shareLinks" class="hidden mt-4">
        <h3 class="font-semibold mb-2">Share these links with players</h3>
        <p class="text-xs text-slate-600 mb-2">Each link opens the game as a specific role and pre-fills the passcode. Share directly or copy the invite text.</p>
        <div id="linksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>
        <h4 class="mt-4 font-semibold">View links (read-only)</h4>
        <p class="text-xs text-slate-600 mb-2">Open a fixed view with trend lines for classroom projection.</p>
        <div id="viewLinksGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3"></div>
        <div class="mt-2 flex items-center gap-3">
          <button id="openAllViewsBtn" class="btn btn-primary">Open all 5 view tabs</button>
          <span class="text-xs text-slate-500">If tabs don’t open, allow pop-ups and click again.</span>
        </div>
        <div class="mt-3">
          <label class="block text-sm font-medium mb-1">Invite text (email/Slack)</label>
          <textarea id="inviteText" class="w-full border rounded-lg p-2 font-mono text-xs" rows="4" readonly></textarea>
          <div class="mt-2 flex gap-2">
            <button id="copyInvitesBtn" class="btn btn-secondary">Copy All Invites</button>
          </div>
        </div>
      </div>
      <hr class="my-4" />
      <div id="scoreboard" class="overflow-x-auto"></div>
    </section>

    <!-- Player -->
    <section class="card hidden" id="playerPanel">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Player — <span id="playerNameHdr" class="font-mono"></span></h2>
        <div class="flex items-center gap-2">
          <label class="text-sm">Role</label>
          <select id="roleSelect" class="border rounded-lg p-2">
            <option value="hospital">Hospital</option>
            <option value="dc_regional">Regional DC</option>
            <option value="dc_prime">Prime Vendor DC</option>
            <option value="factory">Manufacturer</option>
          </select>
        </div>
      </div>
      <div class="mt-2 text-sm text-slate-600">Session <span id="playerSessionCode" class="font-mono"></span> • Week <b id="playerWeekLbl">—</b></div>
      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div id="roleStats" class="space-y-2"></div>
        <div class="card bg-slate-50">
          <h3 class="font-semibold mb-2">Your Requisition</h3>
          <div class="flex items-center gap-2">
            <input id="orderInput" type="number" min="0" class="w-40 border rounded-lg p-2" placeholder="units" />
            <button id="submitOrderBtn" class="btn btn-primary">Submit (this week)</button>
          </div>
          <div id="lanePeek" class="mt-4 text-sm text-slate-600"></div>
        </div>
      </div>
    </section>

    <!-- View-only Panel -->
    <section class="card hidden" id="viewPanel">
      <h2 class="text-lg font-semibold"><span id="viewTitle">View</span></h2>
      <div id="viewBody" class="mt-3"></div>
    </section>

    <!-- Setup (hidden because config is hardcoded) -->
    <section class="card hidden">
      <h2 class="text-lg font-semibold mb-3">Setup</h2>
      <p class="text-sm text-slate-600 mb-2">Firebase config is <b>hardcoded</b> to your project; no action needed.</p>
      <textarea id="firebaseCfg" class="w-full border rounded-lg p-2 font-mono text-xs opacity-60 cursor-not-allowed" rows="6" readonly></textarea>
      <div class="mt-2 flex items-center gap-2">
        <button id="saveCfgBtn" class="btn btn-secondary">Save Config</button>
        <button id="hardResetBtn" class="btn btn-secondary">Hard Reset (local)</button>
      </div>
    </section>
  </div>

  <!-- App (lean) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js';

    // --- Firebase bootstrap (hardcoded config)
    const HARDCODED_CFG = {
      apiKey: "AIzaSyB2S2bJjgSGQ9wvCImvEU3VxQJGjNgHSl8",
      authDomain: "jh-sc-game.firebaseapp.com",
      projectId: "jh-sc-game",
      storageBucket: "jh-sc-game.firebasestorage.app",
      messagingSenderId: "359971857249",
      appId: "1:359971857249:web:eb3f8605c260d0b46edb20",
      measurementId: "G-R081YTPNK3"
    };

    const cfgEl = document.getElementById('firebaseCfg');
    if (cfgEl) {
      cfgEl.value = JSON.stringify(HARDCODED_CFG, null, 2);
      cfgEl.readOnly = true;
      cfgEl.classList.add('opacity-60','cursor-not-allowed');
    }
    let app=null, db=null, writeKey='';
    function init(){
      try{ app = initializeApp(HARDCODED_CFG); db = getFirestore(app); setStatus('connected','green'); }
      catch(e){ setStatus('config error','red'); console.error(e); }
    }
    function setStatus(text,color){ const p=document.getElementById('statusPill'); p.textContent=text; p.className=`pill bg-${color}-100 text-${color}-700`; }
    init();
    document.getElementById('saveCfgBtn').onclick=()=>{ toast('Config is hardcoded'); };
    document.getElementById('hardResetBtn').onclick=()=>{ localStorage.clear(); location.reload(); };

    // --- Model & helpers
    const ROLES=['hospital','dc_regional','dc_prime','factory'];
    const LABEL={hospital:'Hospital',dc_regional:'Regional DC',dc_prime:'Prime Vendor DC',factory:'Manufacturer'};
    const sessionsCol=()=>collection(db,'sessions');
    function seedBase(weeks){ return Array.from({length:weeks},(_,i)=>{const w=i+1; return Math.round(100*(w>=6&&w<=10?1.5:1));}); }
    function parseRanges(str,weeks){ const f=Array.from({length:weeks},()=>false); (str||'').split(',').map(s=>s.trim()).filter(Boolean).forEach(t=>{ if(/^\d+$/.test(t)){const w=+t; if(w>=1&&w<=weeks) f[w-1]=true; } else { const m=t.match(/^(\d+)\s*[-:]\s*(\d+)$/); if(m){ let a=+m[1],b=+m[2]; if(a>b)[a,b]=[b,a]; for(let w=a;w<=b&&w<=weeks;w++) f[w-1]=true; } } }); return f; }
    function effCons(scn,base,week){ return scn==='Severe Surge + Recall' ? Math.round((base[week-1]||0)*(week>=6&&week<=12?1.8:1)) : (base[week-1]||0); }
    function controlFromUI(){ const weeks=+el('weeks').value||24; const baseTxt=(el('baseDemand').value||'').trim(); let base=baseTxt? baseTxt.split(',').map(x=>+x.trim()||0).slice(0,weeks) : seedBase(weeks); if(base.length<weeks) base=base.concat(Array(weeks-base.length).fill(base.at(-1)||0)); return { itemName:el('itemName').value||'PPE - N95 Masks', weeks, leadTime:+el('leadTime').value||2, initInv:+el('initInv').value||120, scenario:el('scenario').value, baseConsumption:base, factoryOutage:parseRanges(el('factoryOutage').value,weeks), primeOutage:parseRanges(el('primeOutage').value,weeks) }; }
    function compute(control,ordersByRole,currentWeek){ const W=Math.min(currentWeek,control.weeks),L=control.leadTime,S={}; ROLES.forEach(r=>S[r]={onStart:Array(W+1).fill(0),boStart:Array(W+1).fill(0),rcv:Array(W+1).fill(0),dem:Array(W+1).fill(0),ship:Array(W+1).fill(0),onEnd:Array(W+1).fill(0),boEnd:Array(W+1).fill(0),fill:Array(W+1).fill(1)}); ROLES.forEach(r=>S[r].onStart[1]=control.initInv); const ORD=(r,w)=>ordersByRole[r]?.[w]??0; for(let w=1;w<=W;w++){ S.hospital.dem[w]=effCons(control.scenario,control.baseConsumption,w); S.dc_regional.dem[w]=ORD('hospital',w); S.dc_prime.dem[w]=ORD('dc_regional',w); S.factory.dem[w]=ORD('dc_prime',w); const up=r=>r==='hospital'?'dc_regional':r==='dc_regional'?'dc_prime':r==='dc_prime'?'factory':null; ROLES.forEach(r=>{ const u=up(r); const arr=(w-L)>=1?(S[u]?.ship[w-L]||0):0; S[r].rcv[w]=u?arr:0; }); ROLES.forEach(r=>{ const X=S[r]; const supply=(X.onStart[w]||0)+(X.rcv[w]||0); const need=(X.dem[w]||0)+(X.boStart[w]||0); let ship=Math.min(supply,need); if(r==='factory'&&control.factoryOutage[w-1]) ship=0; if(r==='dc_prime'&&control.primeOutage[w-1]) ship=0; X.ship[w]=ship; X.onEnd[w]=supply-ship; X.boEnd[w]=Math.max(need-supply,0); X.fill[w]=need>0?ship/need:1; }); if(w<W){ ROLES.forEach(r=>{ S[r].onStart[w+1]=S[r].onEnd[w]; S[r].boStart[w+1]=S[r].boEnd[w]; }); } } return S; }
    function toIntMap(o){ const m={}; Object.entries(o||{}).forEach(([k,v])=>m[+k]=+v||0); return m; }
    const el=id=>document.getElementById(id);
    function showError(msg){ const b=el('errorBanner'); if(!b) return; b.textContent = msg; b.classList.remove('hidden'); }
    function clearError(){ const b=el('errorBanner'); if(!b) return; b.textContent=''; b.classList.add('hidden'); }

    // Link builders (pure helpers)
    function buildRoleLink(base, code, role){
      return `${base}?code=${encodeURIComponent(code)}&role=${encodeURIComponent(role)}&k=${encodeURIComponent(writeKey)}`;
    }
    function buildViewLink(base, code, view){
      return `${base}?code=${encodeURIComponent(code)}&view=${encodeURIComponent(view)}&k=${encodeURIComponent(writeKey)}`;
    }

    // Build and show four shareable URLs (one per role)
    function setShareLinks(code){
      const base = location.origin + location.pathname;
      const grid = el('linksGrid');
      const cards = ROLES.map(r=>({ r, link: buildRoleLink(base, code, r) }));
      grid.innerHTML = cards.map(({r,link})=>
        `<div class='p-3 bg-slate-50 rounded-lg'>
          <div class='text-xs text-slate-500 mb-1'>${LABEL[r]}</div>
          <input class='w-full text-xs font-mono border rounded p-1' value='${link}' readonly />
          <button class='btn btn-secondary w-full mt-2' data-link='${link}'>Copy</button>
        </div>`
      ).join('');
      el('shareLinks').classList.remove('hidden');
      grid.querySelectorAll('button[data-link]').forEach(btn=>{
        btn.onclick=async()=>{ await navigator.clipboard.writeText(btn.dataset.link); toast('Link copied'); };
      });
      const invite = buildInviteText(code, cards);
      const inviteEl = el('inviteText'); inviteEl.value = invite;
      el('copyInvitesBtn').onclick = async ()=>{ await navigator.clipboard.writeText(inviteEl.value); toast('Invites copied'); };

      // View links (summary + each role)
      const vgrid = el('viewLinksGrid');
      if(vgrid){
        const items = [
          {label:'Overall Summary', view:'summary'},
          {label: LABEL.hospital, view:'hospital'},
          {label: LABEL.dc_regional, view:'dc_regional'},
          {label: LABEL.dc_prime, view:'dc_prime'},
          {label: LABEL.factory, view:'factory'}
        ];
        vgrid.innerHTML = items.map(v=>{
          const vlink = buildViewLink(base, code, v.view);
          return `<div class='p-3 bg-slate-50 rounded-lg'>
            <div class='text-xs text-slate-500 mb-1'>${v.label}</div>
            <input class='w-full text-xs font-mono border rounded p-1' value='${vlink}' readonly />
            <button class='btn btn-secondary w-full mt-2' data-vlink='${vlink}'>Copy</button>
          </div>`;
        }).join('');
        vgrid.querySelectorAll('button[data-vlink]').forEach(btn=>{
          btn.onclick=async()=>{ await navigator.clipboard.writeText(btn.dataset.vlink); toast('Link copied'); };
        });
      }

      // Open-all button
      const openAllBtn = el('openAllViewsBtn');
      if(openAllBtn){
        openAllBtn.onclick=()=>{
          const views=['summary','hospital','dc_regional','dc_prime','factory'];
          const urls = views.map(v=> buildViewLink(base, code, v));
          let opened=0; urls.forEach(u=>{ const w=window.open(u,'_blank'); if(w) opened++; });
          if(opened<urls.length) toast('Some tabs were blocked—enable pop-ups and click again.');
        };
      }
    });
      grid.innerHTML = cards.map(({r,link})=>
        `<div class='p-3 bg-slate-50 rounded-lg'>
          <div class='text-xs text-slate-500 mb-1'>${LABEL[r]}</div>
          <input class='w-full text-xs font-mono border rounded p-1' value='${link}' readonly />
          <button class='btn btn-secondary w-full mt-2' data-link='${link}'>Copy</button>
        </div>`
      ).join('');
      el('shareLinks').classList.remove('hidden');
      grid.querySelectorAll('button[data-link]').forEach(btn=>{
        btn.onclick=async()=>{ await navigator.clipboard.writeText(btn.dataset.link); toast('Link copied'); };
      });
      const invite = buildInviteText(code, cards);
      const inviteEl = el('inviteText'); inviteEl.value = invite;
      el('copyInvitesBtn').onclick = async ()=>{ await navigator.clipboard.writeText(inviteEl.value); toast('Invites copied'); };

      // View links (summary + each role)
      const vgrid = el('viewLinksGrid');
      if(vgrid){
        const items = [
          {label:'Overall Summary', view:'summary'},
          {label: LABEL.hospital, view:'hospital'},
          {label: LABEL.dc_regional, view:'dc_regional'},
          {label: LABEL.dc_prime, view:'dc_prime'},
          {label: LABEL.factory, view:'factory'}
        ];
        vgrid.innerHTML = items.map(v=>{
          const vlink = `${base}?code=${encodeURIComponent(code)}&view=${encodeURIComponent(v.view)}&k=${encodeURIComponent(writeKey)}`;
          return `<div class='p-3 bg-slate-50 rounded-lg'>
            <div class='text-xs text-slate-500 mb-1'>${v.label}</div>
            <input class='w-full text-xs font-mono border rounded p-1' value='${vlink}' readonly />
            <button class='btn btn-secondary w-full mt-2' data-vlink='${vlink}'>Copy</button>
          </div>`;
        }).join('');
        vgrid.querySelectorAll('button[data-vlink]').forEach(btn=>{
          btn.onclick=async()=>{ await navigator.clipboard.writeText(btn.dataset.vlink); toast('Link copied'); };
        });
      }
    }

    function buildInviteText(code, cards){
      const lines = [
        `Session ${code} — pick your link:`,
        ...cards.map(({r,link})=>`• ${LABEL[r]}: ${link}`)
      ];
      // Use literal \n so this is safe in JS, and still renders properly inside the readonly <textarea>.
      return lines.join('\n');
    }

    // Simple sparkline helpers for view links
    function sparklinePath(values, width=360, height=90, pad=8){
      const n=values.length; if(n===0) return '';
      const min=Math.min(...values), max=Math.max(...values);
      const span = (max-min)||1; const w=width-2*pad, h=height-2*pad; const dx = n>1? w/(n-1) : 0;
      let d='';
      for(let i=0;i<n;i++){
        const x = pad + dx*i;
        const y = pad + h - ((values[i]-min)/span)*h;
        d += (i===0?'M':'L') + x.toFixed(2) + ' ' + y.toFixed(2) + ' ';
      }
      return d.trim();
    }
    function sparklineSVG(values,{width=360,height=90,pad=8,colorClass='text-sky-600'}={}){
      const path = sparklinePath(values,width,height,pad);
      return `<div class='${colorClass}'><svg width='${width}' height='${height}' viewBox='0 0 ${width} ${height}'><path d='${path}' fill='none' stroke='currentColor' stroke-width='2'/></svg></div>`;
    }
    function chartCard(label, values, big=false){
      const w = big? 640 : 360; const h = big? 160 : 90;
      return `<div class='p-4 bg-white rounded-xl shadow'>
        <div class='text-sm text-slate-600 mb-2'>${label}</div>
        ${sparklineSVG(values,{width:w,height:h})}
        <div class='text-xs text-slate-500 mt-1'>Last: <b class='mono'>${values.at(-1)??0}</b></div>
      </div>`;
    }
    function renderView(d){
      const titleEl = el('viewTitle'); const body = el('viewBody');
      const c=d.control; const ordersByRole={}; ROLES.forEach(r=>ordersByRole[r]=toIntMap(d.orders?.[r]||{}));
      const S=compute(c,ordersByRole,d.currentWeek);
      const vals=(r)=>{ const out=[]; for(let w=1; w<=d.currentWeek; w++){ out.push(S[r].onEnd[w]||0); } return out; };
      if(viewTarget==='summary'){
        titleEl.textContent = 'Overall Summary — Inventory Trend';
        body.innerHTML = `<div class='grid md:grid-cols-2 lg:grid-cols-2 gap-4'>${ROLES.map(r=>chartCard(LABEL[r], vals(r))).join('')}</div>`;
      } else if(ROLES.includes(viewTarget)){
        titleEl.textContent = `${LABEL[viewTarget]} — Inventory Trend`;
        body.innerHTML = chartCard(LABEL[viewTarget], vals(viewTarget), true);
      } else {
        titleEl.textContent = 'View'; body.innerHTML = `<div class='text-sm text-slate-600'>Unknown view key: <span class='font-mono'>${viewTarget}</span></div>`;
      }
    }

    // Auto-join support via URL params (?code=...&k=...&role=hospital&n=Alice&view=summary)
    async function autoJoinFromURL(){
      try{
        if(!db) return; // firebase not configured
        const qs = new URLSearchParams(location.search);
        const code = (qs.get('code')||'').toUpperCase();
        const key  = qs.get('k') || '';
        const role = (qs.get('role') || '').toLowerCase();
        const name = qs.get('n') || '';
        const view = (qs.get('view') || '').toLowerCase();
        if(!code) return;
        el('codeInput').value = code; if(key) el('passInput').value = key; if(name) el('nameInput').value = name;
        const ref = await joinSession(code);
        if(!ref) return;
        const s = await getDoc(ref);
        const wk = s.data()?.writeKey || '';
        if(view){
          viewMode = true; viewTarget = view;
          attach(ref);
          return;
        }
        if(key && key===wk){
          writeKey = key; isInstructor=false; myName = name || 'Player';
          if(role && ROLES.includes(role)) { roleLocked = true; lockedRole = role; }
          attach(ref);
          if(role && ROLES.includes(role)){
            setTimeout(()=>{ const sel=el('roleSelect'); if(sel){ sel.value = lockedRole; renderPlayer(s.data()); } }, 0);
          }
        }
      }catch(e){ /* silent */ }
    }

    // --- Firestore ops (passcode protected)
    async function createSession(code,name){ const control=controlFromUI(); const ref=doc(sessionsCol(),code); await update(ref,{ code,instructor:name,createdAt:serverTimestamp(),currentWeek:1,transparency:false,control,orders:{},writeKey:writeKey||'CLASS' }, true); return ref; }
    async function joinSession(code){ const ref=doc(sessionsCol(),code); const s=await getDoc(ref); return (s && s.exists())?ref:null; }
    async function setTransparency(ref,val){ await update(ref,{ transparency:!!val, writeKey }); }
    async function advanceWeek(ref){ const s=await getDoc(ref); if(!s.exists()) return; const cur=s.data().currentWeek||1; const W=s.data().control.weeks||24; await update(ref,{ currentWeek:Math.min(cur+1,W), writeKey }); }
    async function applyControl(ref){ await update(ref,{ control:controlFromUI(), currentWeek:1, orders:{}, writeKey }); }
    async function resetSession(ref){ const s=await getDoc(ref); if(!s.exists()) return; await update(ref,{ currentWeek:1, orders:{}, writeKey }); }
    async function submitOrder(ref,role,week,qty){ const s=await getDoc(ref); const orders=s.data().orders||{}; const r=orders[role]||{}; r[week]=Math.max(0,Math.floor(+qty||0)); orders[role]=r; await update(ref,{ orders, writeKey }); }
    async function update(ref,payload,create=false){
      try{
        return create? setDoc(ref,payload) : updateDoc(ref,payload);
      }catch(e){
        const msg = (e && e.message) ? e.message : 'Unknown write error';
        showError('Write failed: ' + msg + (e?.code ? ` (code: ${e.code})` : ''));
        throw e;
      }
    }

    // --- UI
    let sessionRef=null,isInstructor=false,myName='';
    let roleLocked=false, lockedRole='';
    let viewMode=false, viewTarget='';
    el('createBtn').onclick=async()=>{ if(!db){alert('Add Firebase config first.');return;} const code=(el('codeInput').value||'').trim().toUpperCase(); const name=(el('nameInput').value||'').trim()||'Instructor'; const pass=(el('passInput').value||'').trim(); if(!code||!pass){alert('Enter code and passcode.');return;} writeKey=pass; const ref=await createSession(code,name); attach(ref); isInstructor=true; myName=name; setShareLinks(code); };
    el('joinBtn').onclick=async()=>{ if(!db){alert('Add Firebase config first.');return;} const code=(el('codeInput').value||'').trim().toUpperCase(); const name=(el('nameInput').value||'').trim()||'Player'; const pass=(el('passInput').value||'').trim(); if(!code){alert('Enter code.');return;} const ref=await joinSession(code); if(!ref){alert('Session not found.');return;} const s=await getDoc(ref); const wk=s.data()?.writeKey||''; if(!pass||pass!==wk){alert('Incorrect passcode.');return;} writeKey=pass; attach(ref); isInstructor=false; myName=name; };
    el('applyControlBtn').onclick=async()=>{ if(sessionRef) await applyControl(sessionRef); };
    el('advanceBtn').onclick=async()=>{ if(sessionRef) await advanceWeek(sessionRef); };
    el('transparencyChk').onchange=async(e)=>{ if(sessionRef) await setTransparency(sessionRef,e.target.checked); };
    el('submitOrderBtn').onclick=async()=>{ const role=el('roleSelect').value; const qty=el('orderInput').value; const s=await getDoc(sessionRef); const w=s.data().currentWeek; await submitOrder(sessionRef,role,w,qty); };
    el('roleSelect').onchange=()=>{ if(roleLocked){ el('roleSelect').value = lockedRole; toast('Role is locked by invite link'); return; } renderPlayer(); };
    el('resetBtn').onclick=async()=>{ if(sessionRef) await resetSession(sessionRef); };

    function attach(ref){
      sessionRef=ref;
      document.getElementById('sessionCodeHdr').textContent=ref.id;
      document.getElementById('playerSessionCode').textContent=ref.id;
      document.getElementById('lobby').classList.add('hidden');
      const instr = document.getElementById('instructorPanel');
      const player = document.getElementById('playerPanel');
      const viewEl = document.getElementById('viewPanel');
      if(viewMode){ viewEl.classList.remove('hidden'); instr.classList.add('hidden'); player.classList.add('hidden'); }
      else { (isInstructor? instr : player).classList.remove('hidden'); viewEl.classList.add('hidden'); }
      onSnapshot(ref,
        (snap)=>{
          const d=snap.data(); if(!d) return;
          document.getElementById('currentWeekLbl').textContent=d.currentWeek;
          document.getElementById('playerWeekLbl').textContent=d.currentWeek;
          document.getElementById('transparencyChk').checked=!!d.transparency;
          clearError();
          setStatus('connected','green');
          if(viewMode) renderView(d);
          else { renderInstructor(d); if(!isInstructor) renderPlayer(d); }
        },
        (err)=>{
          showError('Live update error: ' + err.message);
          setStatus('live error','amber');
        }
      );
    }

    function renderInstructor(d){ const c=d.control; el('itemName').value=c.itemName; el('weeks').value=c.weeks; el('leadTime').value=c.leadTime; el('initInv').value=c.initInv; el('scenario').value=c.scenario; el('factoryOutage').value=spanify(c.factoryOutage); el('primeOutage').value=spanify(c.primeOutage); el('baseDemand').value=(c.baseConsumption||[]).join(', '); const ordersByRole={}; ROLES.forEach(r=>ordersByRole[r]=toIntMap(d.orders?.[r]||{})); const S=compute(c,ordersByRole,d.currentWeek); const tbl=document.createElement('table'); tbl.className='w-full text-sm'; tbl.innerHTML=`<thead><tr class='text-left text-slate-500'><th class='py-2'>Role</th><th>Ship</th><th>On-hand</th><th>Backlog</th><th>Fill%</th><th>Order (wk ${d.currentWeek})</th></tr></thead><tbody>${ROLES.map(r=>{const X=S[r],w=d.currentWeek;const fr=((X.fill[w]||1)*100).toFixed(0)+'%';const ord=ordersByRole[r][w]||0;return `<tr class='border-t'><td class='py-1'>${LABEL[r]}</td><td class='mono'>${X.ship[w]||0}</td><td class='mono'>${X.onEnd[w]||X.onStart[w]||0}</td><td class='mono'>${X.boEnd[w]||X.boStart[w]||0}</td><td class='mono'>${fr}</td><td class='mono'>${ord}</td></tr>`}).join('')}</tbody>`; const box=el('scoreboard'); box.innerHTML=''; box.appendChild(tbl); }

    function renderPlayer(d){ d=d||{}; el('playerNameHdr').textContent=myName||'Player'; const role = (roleLocked && lockedRole) ? lockedRole : el('roleSelect').value; const sel=el('roleSelect'); if(sel){ sel.value = role; sel.disabled = !!roleLocked; } const c=d.control||controlFromUI(); const ordersByRole={}; ROLES.forEach(r=>ordersByRole[r]=toIntMap(d.orders?.[r]||{})); const S=compute(c,ordersByRole,d.currentWeek||1); const w=d.currentWeek||1; const X=S[role]; el('roleStats').innerHTML=`<div class='grid grid-cols-2 gap-2 text-sm'><div>Orders from downstream</div><div class='mono'>${X.dem[w]||0}</div><div>Receipts (delayed)</div><div class='mono'>${X.rcv[w]||0}</div><div>Ship to downstream</div><div class='mono'>${X.ship[w]||0}</div><div>On-hand end</div><div class='mono'>${X.onEnd[w]||X.onStart[w]||0}</div><div>Backlog end</div><div class='mono'>${X.boEnd[w]||X.boStart[w]||0}</div><div>Fill rate</div><div class='mono'>${((X.fill[w]||1)*100).toFixed(0)}%</div></div>`; el('lanePeek').innerHTML = d.transparency ? `<div><b>All lanes (wk ${w})</b><div class='grid grid-cols-2 md:grid-cols-4 gap-2 mt-2'>${ROLES.map(r=>{const Y=S[r];return `<div class='p-3 bg-white rounded-xl shadow'><div class='text-xs text-slate-500'>${LABEL[r]}</div><div class='text-sm'>Ship: <b class='mono'>${Y.ship[w]||0}</b></div><div class='text-sm'>OH: <b class='mono'>${Y.onEnd[w]||0}</b></div><div class='text-sm'>BO: <b class='mono'>${Y.boEnd[w]||0}</b></div></div>`}).join('')}</div></div>` : '<div class="text-xs text-slate-500">Transparency Off</div>'; const myOrd=ordersByRole[role][w]||''; el('orderInput').value=myOrd; }

    function spanify(f){ let s='',i=0,W=f?.length||0; while(i<W){ if(f[i]){ let j=i; while(j+1<W&&f[j+1]) j++; s+=(s?', ':'')+(i+1)+(i===j?'':'-'+(j+1)); i=j+1; } else i++; } return s; }

    // Kick off auto-join if URL contains params
    autoJoinFromURL();

    // --------- Minimal self-tests (console only) ---------
    (function selfTests(){
      try{
        const pr = parseRanges('2, 4-6, 9', 10);
        console.assert(pr.length===10 && pr[1] && pr[3] && pr[4] && pr[5] && pr[8] && !pr[0], 'parseRanges basic failed');
        const ctrl={ itemName:'Test', weeks:4, leadTime:1, initInv:50, scenario:'Normal', baseConsumption:[10,10,10,10], factoryOutage:[false,false,false,false], primeOutage:[false,false,false,false] };
        const orders={ hospital:{1:10,2:10}, dc_regional:{1:10,2:10}, dc_prime:{1:10,2:10}, factory:{1:10,2:10} };
        const S=compute(ctrl,{hospital:orders.hospital,dc_regional:orders.dc_regional,dc_prime:orders.dc_prime,factory:orders.factory},2);
        console.assert(Array.isArray(S.hospital.ship) && S.hospital.ship[1] >= 0, 'compute structure failed');
        const invite=buildInviteText('TEST',[{r:'hospital',link:'https://x'}]);
        console.assert(invite.includes('\n'), 'invite newline join failed');
        (function(){
          const c = { itemName:'x', weeks:3, leadTime:0, initInv:50, scenario:'Normal', baseConsumption:[10,10,10], factoryOutage:[false,false,true], primeOutage:[false,false,false] };
          const o = { hospital:{1:10,2:10,3:10}, dc_regional:{}, dc_prime:{}, factory:{} };
          const Sx = compute(c, {hospital:o.hospital, dc_regional:{}, dc_prime:{}, factory:{}}, 3);
          console.assert(Sx.factory.ship[3]===0, 'factory outage not enforced');
        })();
        (function(){
          const c = { itemName:'x', weeks:3, leadTime:1, initInv:0, scenario:'Normal', baseConsumption:[0,0,0], factoryOutage:[false,false,false], primeOutage:[false,false,false] };
          const o = { hospital:{1:5}, dc_regional:{1:5}, dc_prime:{1:5}, factory:{1:5} };
          const Sy = compute(c, {hospital:o.hospital, dc_regional:o.dc_regional, dc_prime:o.dc_prime, factory:o.factory}, 2);
          console.assert(Sy.dc_regional.rcv[2] >= 0, 'lead time receipt missing at t+1');
        })();
        (function(){ setStatus('connected','green'); const pill = document.getElementById('statusPill'); console.assert(pill.className.includes('bg-green-100') && pill.className.includes('text-green-700'), 'status pill classes missing'); })();
        // New: spanify compaction test
        (function(){
          const s = spanify([false,true,true,false,true,false,false,true]);
          console.assert(s==='2-3, 5, 8', 'spanify compaction failed: ' + s);
        })();
        (function(){ const p = sparklinePath([0,5,10], 100, 40, 4); console.assert(typeof p==='string' && p.startsWith('M') && p.includes('L'), 'sparkline path invalid'); })();
        (function(){
          const base='https://example.test/app';
          const url = buildViewLink(base,'ABCD','summary');
          console.assert(url.includes('view=summary') && url.includes('code=ABCD'), 'buildViewLink failed: ' + url);
        })();
        console.log('%cSelf-tests OK','color:green');
      }catch(e){ console.warn('Self-tests exception', e); }
    })();
  </script>
</body>
</html>
